

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="">
    
    
      
        <title>21. Physical Memory Protection - RISC-V VeeR EL2 Programmer's Reference Manual  documentation</title>
      
    
    
      
        
        
      
      

    
    
    
      
        
        
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
        <link rel="stylesheet" type="text/css" href="_static/sphinx_immaterial_theme.02cb18745d09eea51.min.css?v=ff456132" />
        <link rel="stylesheet" type="text/css" href="_static/main.css" />
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="white">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="index.html" title="RISC-V VeeR EL2 Programmer&#39;s Reference Manual  documentation" class="md-header__button md-logo" aria-label="RISC-V VeeR EL2 Programmer's Reference Manual  documentation" data-md-component="logo">
      <img src="_static/white.svg" alt="logo">
    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RISC-V VeeR EL2 Programmer's Reference Manual  documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              21. Physical Memory Protection
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="white"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
      </form>
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="index.html" title="RISC-V VeeR EL2 Programmer&#39;s Reference Manual  documentation" class="md-nav__button md-logo" aria-label="RISC-V VeeR EL2 Programmer's Reference Manual  documentation" data-md-component="logo">
      <img src="_static/white.svg" alt="logo">
    </a>
    RISC-V VeeR EL2 Programmer's Reference Manual  documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="intro.html" class="md-nav__link">
        <span class="md-ellipsis">RISC-<wbr>V Vee<wbr>R EL2 Programmer’s Reference Manual</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="overview.html" class="md-nav__link">
        <span class="md-ellipsis">Core Overview</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="memory-map.html" class="md-nav__link">
        <span class="md-ellipsis">Memory Map</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="error-protection.html" class="md-nav__link">
        <span class="md-ellipsis">Memory Error Protection</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="dual-core-lock-step.html" class="md-nav__link">
        <span class="md-ellipsis">Dual-<wbr>Core Lockstep <wbr>(DCLS)</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="timers.html" class="md-nav__link">
        <span class="md-ellipsis">Internal Timers</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="power.html" class="md-nav__link">
        <span class="md-ellipsis">Power Management and Multi-<wbr>Core Debug Control</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="interrupts.html" class="md-nav__link">
        <span class="md-ellipsis">External Interrupts</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="performance.html" class="md-nav__link">
        <span class="md-ellipsis">Performance Monitoring</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="cache.html" class="md-nav__link">
        <span class="md-ellipsis">Cache Control</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="debugging.html" class="md-nav__link">
        <span class="md-ellipsis">Debug Support</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="core-control.html" class="md-nav__link">
        <span class="md-ellipsis">Low-<wbr>Level Core Control</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="adaptations.html" class="md-nav__link">
        <span class="md-ellipsis">Standard RISC-<wbr>V CSRs with Core-<wbr>Specific Adaptations</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="csrs.html" class="md-nav__link">
        <span class="md-ellipsis">CSR Address Map</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="interrupt-priority.html" class="md-nav__link">
        <span class="md-ellipsis">Interrupt Priorities</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="clocks.html" class="md-nav__link">
        <span class="md-ellipsis">Clock And Reset</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="complex-ports.html" class="md-nav__link">
        <span class="md-ellipsis">Complex Port List</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="build-args.html" class="md-nav__link">
        <span class="md-ellipsis">Build Arguments</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="tests.html" class="md-nav__link">
        <span class="md-ellipsis">Compliance Test Suite Failures</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="errata.html" class="md-nav__link">
        <span class="md-ellipsis">Errata</span>
      </a>
    </li>
  

    
      
      
      

  
  
    
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          <span class="md-ellipsis">Physical Memory Protection</span>
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="#" class="md-nav__link md-nav__link--active">
        <span class="md-ellipsis">Physical Memory Protection</span>
      </a>
      
        

<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#theory-of-operation" class="md-nav__link">
    <span class="md-ellipsis">Theory of Operation</span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#physical-memory-protection-csrs" class="md-nav__link">
    <span class="md-ellipsis">Physical Memory Protection CSRs</span>
  </a>
  
    <nav class="md-nav" aria-label="Physical Memory Protection CSRs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuration-registers-pmpcfgx" class="md-nav__link">
    <span class="md-ellipsis">Configuration Registers <wbr>(pmpcfg<wbr>X)</span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#address-registers-pmpaddrx" class="md-nav__link">
    <span class="md-ellipsis">Address Registers <wbr>(pmpaddr<wbr>X)</span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#exceptions" class="md-nav__link">
    <span class="md-ellipsis">Exceptions</span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pmp-module" class="md-nav__link">
    <span class="md-ellipsis">PMP module</span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#verification" class="md-nav__link">
    <span class="md-ellipsis">Verification</span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pmp-check-example" class="md-nav__link">
    <span class="md-ellipsis">PMP check example</span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="user-mode.html" class="md-nav__link">
        <span class="md-ellipsis">User Mode</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="verification.html" class="md-nav__link">
        <span class="md-ellipsis">Verification</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="simulation-debugging.html" class="md-nav__link">
        <span class="md-ellipsis">Interactive Debugging in Simulation</span>
      </a>
    </li>
  

    
      
      
      

  
  
  
  
    <li class="md-nav__item">
      <a href="tock.html" class="md-nav__link">
        <span class="md-ellipsis">Running Tock OS</span>
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset" role="main">
                  


<h1 id="physical-memory-protection"><span class="section-number">21. </span>Physical Memory Protection<a class="headerlink" href="#physical-memory-protection" title="Link to this heading">¶</a></h1>
<p>The Physical Memory Protection unit implemented in the VeeR EL2 Core is compliant with “Section 3.7 Physical Memory Protection” of <a class="reference internal" href="intro.html#ref-5"><span class="std std-ref">[5]</span></a>.</p>
<p>RISC-V introduces additional regulatory documents regarding memory protection:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/riscv/riscv-spmp/blob/main/rv-spmp-spec.pdf">Supervisor mode PMP (SPMP)</a></p></li>
<li><p><a class="reference external" href="https://github.com/riscv/riscv-tee/blob/main/Smepmp/Smepmp.pdf">PMP enhancements (Smepmp)</a></p></li>
</ul>
<h2 id="theory-of-operation"><span class="section-number">21.1. </span>Theory of Operation<a class="headerlink" href="#theory-of-operation" title="Link to this heading">¶</a></h2>
<p>The PMP module adds a set of CSRs which define memory regions and Read/Write/Execute (RWX) access permissions.
For each memory access, the PMP module checks if accessed memory is on the allowlist.
In case of impermissible memory access, a precise exception is thrown and execution flow is switched to the trap handler.
The PMP distinguishes 3 types of memory accesses: instruction fetch, data load and data store.</p>
<h2 id="physical-memory-protection-csrs"><span class="section-number">21.2. </span>Physical Memory Protection CSRs<a class="headerlink" href="#physical-memory-protection-csrs" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">pmpcfgX</span></code> and <code class="docutils literal notranslate"><span class="pre">pmpaddrX</span></code> CSRs are implemented in the <a class="reference download internal" download="" href="_downloads/4d39907aa605feca882b272dd753fb04/el2_dec_tlu_ctl.sv"><span class="xref download myst"><em>el2_dec_tlu_ctl</em> module</span></a>.
CSR address decoding is generated from either <a class="reference download internal" download="" href="_downloads/bf4883a73cb84f64f5fbf648ddf24379/csrdecode_m"><span class="xref download myst"><em>csrdecode_m</em></span></a> (Machine mode) or <a class="reference download internal" download="" href="_downloads/545b7a6a7188f827b88dfe9a1767e018/csrdecode_mu"><span class="xref download myst"><em>csrdecode_mu</em></span></a> (Machine and User mode) description file.</p>
<p>The number of <code class="docutils literal notranslate"><span class="pre">pmpcfgX</span></code> registers is always 4 times smaller than the number of PMP entries, which are configurable using the <code class="docutils literal notranslate"><span class="pre">-set=pmp_entires=N</span></code> option, where <em>N</em> can be 0, 16 or 64.</p>
<table class="docutils data align-left" id="tab-riscv-pmp-csr-configuration-table">
<caption><span class="caption-number">Table 21.1 </span><span class="caption-text">CSR configurations for RV-32</span><a class="headerlink" href="#tab-riscv-pmp-csr-configuration-table" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p>Number of PMP entries</p></th>
<th class="head"><p>Number of <em>pmpcfgX</em> CSRs</p></th>
<th class="head"><p>Number of <em>pmpaddrX</em> CSRs</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>0</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td><p>16</p></td>
<td><p>4</p></td>
<td><p>16</p></td>
</tr>
<tr class="row-even"><td><p>64</p></td>
<td><p>16</p></td>
<td><p>64</p></td>
</tr>
</tbody>
</table>
<h3 id="configuration-registers-pmpcfgx"><span class="section-number">21.2.1. </span>Configuration Registers (pmpcfgX)<a class="headerlink" href="#configuration-registers-pmpcfgx" title="Link to this heading">¶</a></h3>
<p>Each <code class="docutils literal notranslate"><span class="pre">pmpcfgX</span></code> register holds a configuration for four PMP entries, with a byte used for each entry.</p>
<table class="docutils data align-left" id="tab-riscv-pmpcfgx-register">
<caption><span class="caption-number">Table 21.2 </span><span class="caption-text">Decoding of the <em>pmpcfgX</em> register</span><a class="headerlink" href="#tab-riscv-pmpcfgx-register" title="Link to this table">¶</a></caption>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Bit</strong></p></th>
<th class="head"><p>7</p></th>
<th class="head"><p>6</p></th>
<th class="head"><p>5</p></th>
<th class="head"><p>4</p></th>
<th class="head"><p>3</p></th>
<th class="head"><p>2</p></th>
<th class="head"><p>1</p></th>
<th class="head"><p>0</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><strong>Flag</strong></p></td>
<td><p><em>L</em></p></td>
<td><p><em>0</em></p></td>
<td><p><em>0</em></p></td>
<td><p><em>A[1]</em></p></td>
<td><p><em>A[0]</em></p></td>
<td><p><em>X</em></p></td>
<td><p><em>W</em></p></td>
<td><p><em>R</em></p></td>
</tr>
</tbody>
</table>
<p>Meaning of bit flags:</p>
<ul class="simple">
<li><p><em>L</em> - lock bit; when set to <em>1</em>, given entry cannot be changed (both configuration and address) until hart reset</p></li>
<li><p><em>0</em> - unused bits, always set to <em>0</em></p></li>
<li><p><em>A[1:0]</em> - encodes address matching mode (<em>OFF</em>, <em>TOR</em>, <em>NA4</em>, <em>NAPOT</em>)</p></li>
<li><p><em>X</em> - execute permission; when set to <em>1</em>, allows instruction fetch from the corresponding address region; otherwise memory access will result in an instruction access-fault exception</p></li>
<li><p><em>W</em> - write permission; when set to <em>1</em>, allows data store to the corresponding address region; otherwise memory access will result in a store access-fault exception</p></li>
<li><p><em>R</em> - read permission; when set to <em>1</em>, allows data load from the corresponding address region; otherwise memory access will result in a load access-fault exception.</p></li>
</ul>
<h3 id="address-registers-pmpaddrx"><span class="section-number">21.2.2. </span>Address Registers (pmpaddrX)<a class="headerlink" href="#address-registers-pmpaddrx" title="Link to this heading">¶</a></h3>
<p>PMP address registers (<code class="docutils literal notranslate"><span class="pre">pmpaddrX</span></code>) encode bits 33 to 2 (<code class="docutils literal notranslate"><span class="pre">address[33:2]</span></code>) in physical memory.
This address defines protected memory region boundaries, further interpreted according to address matching values encoded by bits 4 and 3 of the <code class="docutils literal notranslate"><span class="pre">pmpcfgX</span></code> register:</p>
<ul class="simple">
<li><p><em>00</em> OFF Null region (disabled)</p></li>
<li><p><em>01</em> TOR Top of range</p></li>
<li><p><em>10</em> NA4 Naturally aligned four-byte region</p></li>
<li><p><em>11</em> NAPOT Naturally aligned power-of-two region, &gt;=8 bytes</p></li>
</ul>
<h2 id="exceptions"><span class="section-number">21.3. </span>Exceptions<a class="headerlink" href="#exceptions" title="Link to this heading">¶</a></h2>
<p>In case of impermissible memory access, an exception is raised and the exception code is stored in the <code class="docutils literal notranslate"><span class="pre">mcause</span></code> CSR register (<em>0x342</em>).</p>
<table class="docutils data align-default" id="tab-riscv-pmp-exceptions">
<caption><span class="caption-number">Table 21.3 </span><span class="caption-text">PMP related exception codes</span><a class="headerlink" href="#tab-riscv-pmp-exceptions" title="Link to this table">¶</a></caption>
<colgroup>
<col style="width: 21.9%" />
<col style="width: 21.9%" />
<col style="width: 56.2%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><strong>Interrupt flag (<em>mcause[MXLEN-1]</em>)</strong></p></th>
<th class="head"><p><strong>Exception Code (<em>mcause[MXLEN-2:0]</em>)</strong></p></th>
<th class="head"><p><strong>Exception description</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><em>0</em></p></td>
<td><p><em>1</em></p></td>
<td><p>Instruction access fault (cannot read instruction from protected region)</p></td>
</tr>
<tr class="row-odd"><td><p><em>0</em></p></td>
<td><p><em>5</em></p></td>
<td><p>Load access fault (cannot load data from protected region)</p></td>
</tr>
<tr class="row-even"><td><p><em>0</em></p></td>
<td><p><em>7</em></p></td>
<td><p>Store/Atomic Memory Operation access fault (cannot store data to protected region)</p></td>
</tr>
</tbody>
</table>
<p>Whenever a PMP access fault exception is raised, the machine secondary cause register (<code class="docutils literal notranslate"><span class="pre">mscause</span></code>) value is <em>0x03</em> indicating “access out of MPU range”.</p>
<h2 id="pmp-module"><span class="section-number">21.4. </span>PMP module<a class="headerlink" href="#pmp-module" title="Link to this heading">¶</a></h2>
<p>The PMP module is implemented in <a class="reference download internal" download="" href="_downloads/ca1904209f5a6f77a9f5c7547b144e4c/el2_pmp.sv"><span class="xref download myst">el2_pmp.sv</span></a>.
It is meant to be connected to the:</p>
<ul class="simple">
<li><p>CSR configuration table</p></li>
<li><p>CSR addresses table</p></li>
<li><p>configuration inputs for each channel (marking permissions to be checked on a given channel)</p></li>
<li><p>address inputs for each channel (one for IFU, one for LSU)</p></li>
<li><p>error outputs for each channel</p></li>
</ul>
<p>The following functionality has been implemented:</p>
<ul class="simple">
<li><p>decoding address ranges (start address and mask) from address CSRs depending on the address matching mode for a given entry</p></li>
<li><p>comparing addresses coming from a channel to defined ranges</p></li>
<li><p>asserting error flags for given channels depending on permissions from the first matching range.</p></li>
</ul>
<p>Error handling is performed using existing logic in IFU and LSU modules, reusing previously implemented mechanisms.</p>
<figure class="align-default" id="riscv-pmp-block-diagram">
<img alt="riscv_pmp_block_diagram" src="_images/19-riscv_pmp_block_diagram.png" />
<figcaption>
<p><span class="caption-number">Fig. 21.1 </span><span class="caption-text"><span class="caption-text">
PMP integration with other modules of the VeeR EL2 core.</span><a class="headerlink" href="#riscv-pmp-block-diagram" title="Permalink to this image">¶</a></figcaption>
</figure>
<h2 id="verification"><span class="section-number">21.5. </span>Verification<a class="headerlink" href="#verification" title="Link to this heading">¶</a></h2>
<p>The PMP module is tested with:</p>
<ul class="simple">
<li><p><a class="reference download internal" download="" href="_downloads/7f997c89bb8db6febe6729010b5c5034/testbench.py"><span class="xref download myst">RTL tests</span></a></p></li>
<li><p><a class="reference download internal" download="" href="_downloads/b7ecad5961b0c92e92cfdaf65b072c95/main.c"><span class="xref download myst">software smoke tests</span></a></p></li>
<li><p><a class="reference download internal" download="" href="_downloads/c15d42e747ac634cf85448f593a106a4/test-riscv-dv.yml"><span class="xref download myst">RISC-V DV tests</span></a></p></li>
</ul>
<h2 id="pmp-check-example"><span class="section-number">21.6. </span>PMP check example<a class="headerlink" href="#pmp-check-example" title="Link to this heading">¶</a></h2>
<p>In this example we enforce the following permissions:</p>
<ul class="simple">
<li><p><em>0x00000000</em> - <em>0x00000FFF</em> - deny reads, writes, execution</p></li>
<li><p><em>0x00001000</em> - <em>0x00001FFF</em> - allow reads, writes, execution</p></li>
</ul>
<p>First, let’s configure the 2 address regions by writing 2 bytes to the lower 16 bits of the <code class="docutils literal notranslate"><span class="pre">pmpcfg0</span></code> register (each region configuration uses a byte)
PMP configuration registers should be set to:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pmpcfg0[7:0]</span></code> = <em>0b00001000</em> - non-locked entry, top-of-range address matching, all memory access denied.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pmpcfg0[15:8]</span></code> = <em>0b00001111</em> - non-locked entry, top-of-range address matching, all memory access permitted.</p></li>
</ul>
<p>To select top-of-range matching, bits 3 and 4 of the configuration field are set to <em>0b01</em>, which creates a region starting with the address from the previous entry <code class="docutils literal notranslate"><span class="pre">pmpaddrX-1</span></code> and ending at an address in the <code class="docutils literal notranslate"><span class="pre">pmpaddrX</span></code> register, decremented by one.
In case of the first entry on the list, the <em>0x00000000</em> address is used as boundary.</p>
<p>After selecting the addressing mode, we can calculate values of <code class="docutils literal notranslate"><span class="pre">pmpaddr0</span></code> and <code class="docutils literal notranslate"><span class="pre">pmpaddr1</span></code> registers, which will define boundaries of regions.
Addresses stored in <code class="docutils literal notranslate"><span class="pre">pmpaddrX</span></code> CSRs contain bits <em>[33:2]</em> of the memory address.
Thus to select a specific address, it must be shifted by 2 bits to the right before writing the value to the register:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pmpaddr0</span></code> should be <code class="docutils literal notranslate"><span class="pre">(0x00001000</span> <span class="pre">&gt;&gt;</span> <span class="pre">2)</span> <span class="pre">=</span> <span class="pre">0x00000400</span></code>, so that it matches the memory region from <em>0x00000000</em> to <em>0x00000FFF</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pmpaddr1</span></code> should be <code class="docutils literal notranslate"><span class="pre">(0x00002000</span> <span class="pre">&gt;&gt;</span> <span class="pre">2)</span> <span class="pre">=</span> <span class="pre">0x00000800</span></code>, so that it matches the memory region from <em>0x00001000</em> (which is the top address of the previous entry) to <em>0x00001FFF</em>.</p></li>
</ul>
<p>With this configuration, all memory accesses to the first region (<em>0x00000000</em> - <em>0x00000FFF</em>) will fail and trigger an exception.
The exception code can be read to determine the type of the failed operation (instruction fetch, data load or data store).
On the other hand, all memory accesses to the second region (<em>0x00001000</em> - <em>0x00001FFF</em>) will be executed without errors.</p>


  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      2025-05-21
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="errata.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: 20. Errata" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              20. Errata
            </div>
          </div>
        </a>
      
      
        
        <a href="user-mode.html" class="md-footer__link md-footer__link--next" aria-label="Next: 22. User Mode" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              22. User Mode
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  
  
  <div class="md-footer-meta md-typeset">
    
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-footer-copyright__highlight">
        Copyright &#169; 2025 CHIPS Alliance The Linux Foundation®.
        
    </div>
  
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/antmicro" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/antmicro" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
    
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": ["toc.integrate"], "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
      
        <script src="_static/sphinx_immaterial_theme.f9d9eeeb247ace16c.min.js?v=8ec58cb5"></script>
    
  </body>
</html>